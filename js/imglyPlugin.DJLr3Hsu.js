import{a as D,b as L,d as f}from"./cutout-utils.DM8CbSVl.js";import{g as x}from"./main.CIhL9qNv.js";const M={id:"imgly",name:"ImgLy Background Removal",description:"基于 ONNX Runtime 的高精度 AI 抠图",async process(l,s){const{canvas:a,ctx:h,originalImage:n,setStatus:r,yieldToUI:i}=l;try{r("ImgLy 正在分析图片..."),await i(),r("正在准备图像数据...");const o=document.createElement("canvas");o.width=n.width,o.height=n.height,o.getContext("2d").drawImage(n,0,0);const u=await new Promise((e,m)=>{o.toBlob(t=>{t?e(t):m(new Error("无法转换图像为 Blob"))},"image/png")});await i(),r("ImgLy 正在处理...");const y=await x().removeBackground(u,{model:s.model||"isnet_fp16",debug:!1},e=>{r(`ImgLy 处理中: ${e.key} - ${e.percentage}%`)});await i(),r("正在应用处理结果...");const c=URL.createObjectURL(y),g=new Image;await new Promise((e,m)=>{g.onload=()=>e(),g.onerror=()=>m(new Error("结果图片加载失败")),g.src=c}),a.width=g.width,a.height=g.height,h.clearRect(0,0,a.width,a.height),h.drawImage(g,0,0),URL.revokeObjectURL(c);const p=h.getImageData(0,0,a.width,a.height).data,d=new Float32Array(a.width*a.height);for(let e=0;e<p.length;e+=4){const m=e/4;d[m]=p[e+3]/255}await i(),s.morph!==0&&(r("正在调整边缘..."),D(d,a.width,a.height,s.morph),await i()),s.feather>0&&(r("正在羽化边缘..."),L(d,a.width,a.height,s.feather),await i()),r("正在生成最终结果..."),h.clearRect(0,0,a.width,a.height),h.drawImage(n,0,0,a.width,a.height);const w=h.getImageData(0,0,a.width,a.height),I=w.data,k=a.width*100;for(let e=0;e<I.length;e+=4){e>0&&e/4%k===0&&await i();const m=e/4;let t=d[m];t<s.threshold?t=0:t=(t-s.threshold)/(1-s.threshold),t=Math.min(1,Math.max(0,t*(s.opacity/100))),I[e+3]=Math.round(t*255)}return await i(),l.maskShapes&&l.maskShapes.length>0&&(r("正在删除遮罩区域..."),f(w,l.maskShapes),await i()),h.putImageData(w,0,0),{success:!0,message:"ImgLy 处理完成",imageData:h.getImageData(0,0,a.width,a.height)}}catch(o){return console.error("ImgLy 处理失败:",o),{success:!1,message:`处理失败: ${o.message}`}}}};export{M as imglyPlugin};
