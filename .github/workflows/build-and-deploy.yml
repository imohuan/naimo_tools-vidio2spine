name: Build and Deploy

on:
  # åªåœ¨ main åˆ†æ”¯çš„ push è§¦å‘
  push:
    branches:
      - main
      - master
    # åªç›‘å¬ package.json çš„å˜åŒ–
    paths:
      - "package.json"

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼Œç”¨äºåç»­æ“ä½œ

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3. æ£€æŸ¥ version æ˜¯å¦çœŸçš„æ”¹å˜äº†
      - name: Check Version Change
        id: version_check
        run: |
          # è·å–å½“å‰ version
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # è·å–ä¸Šä¸€æ¬¡æäº¤çš„ version
          git checkout HEAD~1 -- package.json 2>/dev/null || echo "No previous version"
          PREVIOUS_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "0.0.0")
          echo "Previous version: $PREVIOUS_VERSION"

          # æ¢å¤å½“å‰ package.json
          git checkout HEAD -- package.json

          # æ¯”è¾ƒç‰ˆæœ¬
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Version not changed, skipping build"
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

      # 4. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        if: steps.version_check.outputs.version_changed == 'true'
        run: npm install

      # 5. ç±»å‹æ£€æŸ¥
      - name: Type Check
        if: steps.version_check.outputs.version_changed == 'true'
        run: npm run type-check

      # 6. æ„å»ºé¡¹ç›®
      - name: Build
        if: steps.version_check.outputs.version_changed == 'true'
        run: npm run build

      # 7. éƒ¨ç½²åˆ° build åˆ†æ”¯
      - name: Deploy to build branch
        if: steps.version_check.outputs.version_changed == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: build
          # å¼ºåˆ¶æ¨é€ï¼Œåˆ é™¤ä¹‹å‰çš„æ‰€æœ‰å†å²è®°å½•
          force_orphan: true
          # æäº¤ä¿¡æ¯
          commit_message: |
            ğŸš€ Deploy v${{ steps.version_check.outputs.new_version }}

            Auto-deployed from commit: ${{ github.event.head_commit.message }}
          # è®¾ç½®æäº¤è€…ä¿¡æ¯
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"

      # 8. è¾“å‡ºæ„å»ºç»“æœ
      - name: Build Summary
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          echo "âœ… Build completed successfully!"
          echo "ğŸ“¦ Version ${{ steps.version_check.outputs.new_version }} deployed to 'build' branch"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ“ Message: ${{ github.event.head_commit.message }}"

      # 9. è·³è¿‡æ„å»ºçš„æç¤º
      - name: Skip Build Notice
        if: steps.version_check.outputs.version_changed == 'false'
        run: |
          echo "â­ï¸ Build skipped - version not changed"
          echo "ğŸ’¡ Update version in package.json to trigger a new build"
